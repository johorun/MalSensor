import networkx as nx
import time
import argparse
import csv
from multiprocessing import Pool as ThreadPool
from functools import partial
import glob

def parseargs():
    parser = argparse.ArgumentParser(description='Malware Detection with centrality.')
    parser.add_argument('-d', '--dir', help='The path of a dir contains benign and malware.', required=True, type=str)
    parser.add_argument('-o', '--output', help='The dir_path of output', required=True, type=str)
    parser.add_argument('-c', '--centrality', help='The type of centrality: degree, katz, closeness, harmonic', required=True, type=str)
    args = parser.parse_args()
    return args

def obtain_sensitive_apis(file):
    sensitive_apis = []
    with open(file, 'r') as f:
        for line in f.readlines():
            if line.strip() == '':
                continue
            else:
                sensitive_apis.append(line.strip())
    return sensitive_apis

def callgraph_extraction(file):
    CG = nx.read_gexf(file)
    return CG

def degree_centrality_feature(file, sensitive_apis):
    sha256 = file.split('/')[-1].split('.')[0]
    CG = callgraph_extraction(file)

    node_centrality = nx.degree_centrality(CG)

    vector = []
    for api in sensitive_apis:
        if api in node_centrality.keys():
            vector.append(node_centrality[api])
            #vector.append(1)
        else:
            vector.append(0)

    return (sha256, vector)

def katz_centrality_feature(file, sensitive_apis):
    sha256 = file.split('/')[-1].split('.')[0]
    CG = callgraph_extraction(file)
    node_centrality = nx.katz_centrality(CG) #此处运行报错
    vector = []
    for api in sensitive_apis:
        if api in node_centrality.keys():
            vector.append(node_centrality[api])
        else:
            vector.append(0)
            
    return (sha256, vector)

def closeness_centrality_feature(file, sensitive_apis):
    sha256 = file.split('/')[-1].split('.')[0]
    CG = callgraph_extraction(file)
    node_centrality = nx.closeness_centrality(CG)
    
    vector = []
    for api in sensitive_apis:
        if api in node_centrality.keys():
            vector.append(node_centrality[api])
        else:
            vector.append(0)

    return (sha256, vector)

def harmonic_centrality_feature(file, sensitive_apis):
    sha256 = file.split('/')[-1].split('.')[0]
    CG = callgraph_extraction(file)
    node_centrality = nx.harmonic_centrality(CG)
    
    vector = []
    for api in sensitive_apis:
        if api in node_centrality.keys():
            vector.append(node_centrality[api])
        else:
            vector.append(0)

    return (sha256, vector)

def obtain_dataset(dataset_path, centrality_type, sensitive_apis):
    Vectors = []
    Labels = []
    Vectors1 = []
    Labels1 = []

    if dataset_path[-1] == '/':
        apps_pre = glob.glob(dataset_path + 'gexf_pre/*.gexf')

        apps_post = glob.glob(dataset_path + 'gexf_post/*.gexf')

        #apps_pre = apps_pre1 + apps_pre2 + apps_pre3 + apps_pre4 + apps_pre5 + apps_pre6 + apps_pre7
        # apps_pre = glob.glob(dataset_path + 'benign/*.gexf')
        # apps_post = glob.glob(dataset_path + 'malware/*.gexf')
    else:
        apps_pre = glob.glob(dataset_path + '/gexf_pre/*.gexf')
        apps_post = glob.glob(dataset_path + '/gexf_post/*.gexf')
    pool_b = ThreadPool(15)
    pool_m = ThreadPool(15)
    if centrality_type == 'degree':
        tic = time.time()
        vector_b = pool_b.map(partial(degree_centrality_feature, sensitive_apis=sensitive_apis), apps_pre)
        vector_m = pool_m.map(partial(degree_centrality_feature, sensitive_apis=sensitive_apis), apps_post)
        tic1 = time.time() - tic
        print(tic1)
    elif centrality_type == 'katz':
        # for apps_pres in apps_pre:
        #     vector_b = katz_centrality_feature(apps_pres, sensitive_apis=sensitive_apis)
        tic = time.time()
        vector_b = pool_b.map(partial(katz_centrality_feature, sensitive_apis=sensitive_apis), apps_pre)
        vector_m = pool_m.map(partial(katz_centrality_feature, sensitive_apis=sensitive_apis), apps_post)
        tic1 = time.time() - tic
        print(tic1)
    elif centrality_type == 'closeness':
        tic = time.time()
        vector_b = pool_b.map(partial(closeness_centrality_feature, sensitive_apis=sensitive_apis), apps_pre)
        vector_m = pool_m.map(partial(closeness_centrality_feature, sensitive_apis=sensitive_apis), apps_post)
        tic1 = time.time() - tic
        print(tic1)
    elif centrality_type == 'harmonic':
        tic = time.time()
        vector_b = pool_b.map(partial(harmonic_centrality_feature, sensitive_apis=sensitive_apis), apps_pre)
        vector_m = pool_m.map(partial(harmonic_centrality_feature, sensitive_apis=sensitive_apis), apps_post)
        tic1 = time.time() - tic
        print(tic1)
    else:
        print('Error Centrality Type!')

    Vectors.extend(vector_b)
    Labels.extend([0 for i in range(len(vector_b))])

    Vectors1.extend(vector_m)
    Labels1.extend([1 for i in range(len(vector_m))])

    return Vectors, Labels, Vectors1, Labels1

def main():
    sensitive_apis_path = '/home/zhj/data2/20230929/MalwareDrift/APIlist.txt'
    sensitive_apis = obtain_sensitive_apis(sensitive_apis_path)    

    args = parseargs()
    dataset_path = args.dir
    cetrality_type = args.centrality

    Vectors, Labels, Vectors1, Labels1 = obtain_dataset(dataset_path, cetrality_type, sensitive_apis)

    feature_csv = [[] for i in range(len(Labels)+1)]
    feature_csv[0].append('SHA256')
    feature_csv[0].extend(sensitive_apis)
    feature_csv[0].append('Label')
    '''
    SHA256,api1,api2,...,Label
    xxxxxx,0,1,0,0,...,0/1
    ...
    
    '''
    for i in range(len(Labels)):
        (sha256, vector) = Vectors[i]
        feature_csv[i+1].append(sha256)
        feature_csv[i+1].extend(vector)
        feature_csv[i+1].append(Labels[i])

    if args.output[-1] == '/':
        csv_path = args.output + 'csv/pre_' + cetrality_type + '_features.csv'
    else:
        csv_path = args.output + '/csv/pre_' + cetrality_type + '_features.csv'

    with open(csv_path, 'w', newline='') as f:
        csvfile = csv.writer(f)
        csvfile.writerows(feature_csv)

    feature_csv1 = [[] for i in range(len(Labels1)+1)]
    feature_csv1[0].append('SHA256')
    feature_csv1[0].extend(sensitive_apis)
    feature_csv1[0].append('Label')

    for i in range(len(Labels1)):
        (sha256, vector) = Vectors1[i]
        feature_csv1[i+1].append(sha256)
        feature_csv1[i+1].extend(vector)
        feature_csv1[i+1].append(Labels1[i])

    if args.output[-1] == '/':
        csv_path = args.output + 'csv/post_' + cetrality_type + '_features.csv'
    else:
        csv_path = args.output + '/csv/post_' + cetrality_type + '_features.csv'

    with open(csv_path, 'w', newline='') as f:
        csvfile = csv.writer(f)
        csvfile.writerows(feature_csv1)

if __name__ == '__main__':
    main()